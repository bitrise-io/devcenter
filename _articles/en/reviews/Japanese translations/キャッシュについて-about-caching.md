---
title: キャッシュについて (About Caching)
redirect_from: []
date: 2019-04-17 13:52:08 +0000
published: false

---
キャッシュは全てのキャッシュされたディレクトリや依存性をtarし、Amazon S3内に安全に保存します。

{% include message_box.html type="info" title="ビルドキャッシュが自動削除されるのはいつですか？" content=" ビルドキャッシュは**特定のブランチ**との関連性があり、**そのブランチ上で新しいビルドが行われなかった場合**、７日後に有効期限が切れます（自動削除されます）。これは**もしその特定のブランチで毎日**（週一回以上のペースで）**ビルドを行えば**、**有効期限が切れる（自動削除される）ことはありません**。７日以上特定のブランチでビルドを開始しなかった場合、関連したキャッシュは削除され、そのブランチにキャッシュがなければ、次のビルドは初期状態で走ることになります。"%}

## セットアップ

### Bitriseのキャッシュステップ

開始するには、まずワークフローに以下の２つのステップを追加してください。

* `Bitrise.io Cache:Pull`ステップは以前のキャッシュ（もしあれば）をダウンロードします。
* `Bitrise.io Cache: Push`ステップはキャッシュの状態をチェックし、必要であればアップロードを行います。

キャッシュを使用する直前に`Bitrise.io Cache:Pull`（ダウンロード）ステップを追加してください。例えば、iOSアプリの場合、`Git Clone Repository`と依存性インストーラーステップ（`Run CocoaPods install`や`Carthage`ステップなど）の間に`Bitrise.io Cache:Pull`を挿入します。`Git Clone Repository`ステップの**前**に`Bitrise.io Cache:Push`ステップの配置は行わないでください。

`Bitrise.io Cache:Push`ステップはワークフローの中でも一番最後のステップになります。

Bitriseの[build-cache discussページ](https://discuss.bitrise.io/tags/build-cache)にてビルドキャッシュの設定例やガイドを確認することができます。

### ファイル・依存性の無視

`Ignore Paths from change check`欄にて**無視**したいキャッシュの項目へパスをセットすることができます。

* パスはキャッシュアーカイブから無視するため`!`の前に付ける必要があります。`!`がパスの前にない場合、そのパスはキャッシュアーカイブから無視されることはありません。また、パスが特定のキャッシュパス項目の中に位置していて、`!`の前にパスがない場合は、そのパスはキャッシュアーカイブに含まれますが、変更へのチェックは行われません。

パス要素（パスの一部分、フルディレクトリを除く）を無視するには、以下の要素を確認してください：

* `*`はパス要素に取って代わることができます。例えば、`a/*/b`は`a/x/b`とマッチします。
* `**`じゃパスの一部分と取って代わることができます。例えば、`a/**/b` は`a/x/y/z/b`とマッチします。
* `/`がディレクトリの**後**に配置されている場合、`/`はフルディレクトリを除外します。例えば、`/my/full/path`は`/my/full/path/`のように見えます。

{% include message_box.html type="info" title="パスの無視に関するTips" content=" 無効なキャッシュ項目と結果が出たパスについては、パスの**無視は行なえません**。例えば、キャッシュされるパスを`a/path/to/cache`と指定する場合、`a/path/to`の無視は行えませんが、全てのファイルを無視し変更のチェックを行わないので、`a/path/to/cache`にフィンガープリントが生成されることはありません。

しかし、**キャッシュパス内部でのパスの無視は行なえます**。例えば、`a/path/to/cache`があなたのパスであれば、ファイル内部にあるのが`a/path/to/cache`だけでない限り、`a/path/to/cache/.ignore-me`を無視することができます。"%}

## キャッシュのダウンロードと削除

アプリの`Settings`タブ、`Manage Build Caches`セクションにあるキャッシュを生成したブランチ毎に、キャッシュのダウンロードと削除が行なえます。

{% include message_box.html type="warning" title="単一ブランチのキャッシュの削除" content=" 単一ブランチに関連性があるキャッシュの削除のみを行う場合、デフォルトブランチのキャッシュも削除しなければなりません！詳細については、[If a build runs on a branch which doesn't have a cache yet, it'll get the main/default Branch's cache](#if-a-build-runs-on-a-branch-which-doesnt-have-a-cache-yet-itll-get-the-maindefault-branchs-cache) をご覧ください。"%}

キャッシュのサイズやポップアップウィンドウで使用されたキャッシュが最後に使用された時間を確認することができます。

## テクニカルノート

### ビルドキャッシュ機能

ビルドキャッシュ機能は、`Build Cache API`と`Steps`の２つに分けることができます。

`Build Cache API`はシンプルなAPIであり、一つの役割を果たします：APIからURLのダウンロードやアップロードをリクエストすることができます。またこれは、リソース（ビルドキャッシュアーカイブ）への必要なアクセス権があることを確実にします。しかし、このAPIの唯一の役割は、安全で・時間制限があり・失効するURLのダウンロード・アップロードを提供することです。ファイルの処理は行われません。

`Steps`は”魔法”がかかる場所でもあります。キャッシュの比較（関連した変更がある場合）やキャッシュアーカイブの作成の全てのロジックがステップによって行われます。また、これは自分自身でステップを書いたり、自分でロジックの比較や圧縮を実行する事ができるという意味でもあります。ビルドキャッシュAPIを使ってURLのダウンロード・アップロードを行うためだけのステップなので、キャッシュファイルフォーマットやその内容に関する制限はありません。

手軽なtips

* 自分自身のキャッシュステップの作成が可能
* 自分自身のビルドキャッシュサーバーとAPIの作成・使用が可能

### キャッシュの利用可・利用不可

もしキャッシュが接続されなければ、正しい手順で失敗しないコード作成をしてください。

### インターネットでダウンロードが行われるキャッシュ

これはCDN/cloudストレージからダウンロードされたファイルを保存している場合、スピードの向上は見られません。それは、キャッシュをBitriseビルドキャッシュストレージからダウンロードするのは、標準的なCDN/cloudストレージ場所からダウンロードするのとほぼ同じくらいの時間がかかるからです。

{% include message_box.html type="important" title="どのタイミングでBitriseビルドキャッシュ内の依存関係を保存するべきですか？" content=" Bitriseビルドキャッシュ内で依存関係を保存することは、リソース・依存関係の標準的なダウンロード場所で**信頼性**に関する問題がある場合に役に立ちます。[PhantomJS](https://github.com/Medium/phantomjs/issues/501)のような人気のあるツール・依存関係においてはレート制限される可能性もあります。CDNサーバーでは、jCenterやBintrayのような利用状況の問題に直面する可能性もあります。例 [#1](http://status.bitrise.io/incidents/gcx1qn5lj7yt), [#2](http://status.bitrise.io/incidents/3ztgwxvwq7rm), [#3](http://status.bitrise.io/incidents/dqpby9m1n274)をご覧ください。これらのケースの場合、Bitriseビルドキャッシュに依存関係を保存することは役に立ちます。ビルド時間の向上は見られないかもしれませんが、**信頼度については必ず向上します**。"%}

### アーカイブファイルとして保存されているキャッシュ

キャッシュしたい複数のパスをお持ちで、パスのどれかがアップデートされていると、キャッシュを行う全てのパスを含む、**全てのキャッシュアーカイブをアップデートします**。

### キャッシュがまだないブランチでビルドを実行する場合、メインもしくはデフォルトのブランチのキャッシュを入手します

デフォルトではないブランチでのビルドは、スピードを上げるため、新ブランチで成功したブランチが見つかるまで`primary`ブランチのキャッシュに接続（読み取り専用）します。一旦新ブランチ上でのビルドがキャッシュをプッシュしたら、そのブランチ上での新しいビルドがブランチのキャッシュを入手します。_キャッシュはブランチ毎で別々に保存され利用可能になります。_

アプリの`Settings`タブをクリックすればどれが自身の**デフォルトブランチ**であるか確認することができます。

コードプッシュによってビルドが開始された場合、キャッシュはプッシュブランチ上で利用可能になり、その同じプッシュブランチからキャッシュがプルされます。プルリクエスト（PR）を開始する場合、そのPRソースブランチのキャッシュはプルされ、同じソースブランチへプッシュされます。タグイベントの場合、コード変更はないので、キャッシュする必要はありません。